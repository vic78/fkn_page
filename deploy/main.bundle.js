(()=>{"use strict";class e{constructor(e=0,t=0){this.lineNumber=e,this.charNumber=t}}const t={inadmissibleSymbol:3,forbiddenCharacter:6,nameNotDescribed:104,breakOutOfLoop:105,identifierAlreadyUsed:106,variableNotDeclared:107,constantOrVariableNotDeclared:108,typesMismatch:109,typeNotDeclared:110,indexIsOutOfRange:111,identifierExpected:112,elementIsNotInitialized:113,notCallableElement:114,arrayExpected:115,recordPropertyIsNotDefined:116};class s{constructor(){this.errorCodeMapper=new Map([[1,"An error in primitive type"],[2,"Name expected"],[t.inadmissibleSymbol,"Inadmissible Symbol"],[t.forbiddenCharacter,"Forbidden character"],[t.nameNotDescribed,"Name is not described"],[t.breakOutOfLoop,"'break' is out of loop"],[t.identifierAlreadyUsed,"Identifier already used"],[t.variableNotDeclared,"Variable not declared"],[t.constantOrVariableNotDeclared,"Constant or variable not declared"],[t.typesMismatch,"Types mismatch"],[t.identifierExpected,"Identifier expected"],[t.indexIsOutOfRange,"Index is out of range"],[t.elementIsNotInitialized,"Element is not initialized"]])}getErrorTextByCode(e){return this.errorCodeMapper.has(e)?this.errorCodeMapper.get(e):null}}class n extends Error{constructor(e,t,s){super(t+` // line ${s.lineNumber} `+` column ${s.charNumber} `),this.errorCode=e,this.errorText=t,this.textPosition=s}}class i extends class{constructor(t,n){this.errorsDescription=new s,this.positionNow=new e,this.printer=t,this.reader=n,this.currentLine,this.currentLineErrors=[],this.lines=[],this.linePointer=0,this.currentLine,this.endOfFile=!1}setLines(e){this.lines=e.split(/\r?\n/),this.readNextLine()}getCurrentPosition(){return new e(this.positionNow.lineNumber,this.positionNow.charNumber)}nextCh(){return this.endOfFile&&this.positionNow.charNumber>=this.currentLine.length?null:(this.positionNow.charNumber===this.currentLine.length&&(this.currentLineErrors.length>0&&this.printer.listErrors(this.currentLineErrors),this.readNextLine(),this.currentLineErrors=[],this.positionNow.lineNumber++,this.positionNow.charNumber=0),this.currentLine[this.positionNow.charNumber++])}prevCh(){return 0===this.linePointer&&0===this.positionNow.charNumber?null:(0===this.positionNow.charNumber&&(this.readPrevLine(),this.currentLineErrors=[],this.positionNow.lineNumber--,this.positionNow.charNumber=this.currentLine.length),this.positionNow.charNumber--,this.currentLine[this.positionNow.charNumber-1])}readNextLine(){var e=this.lines[this.linePointer++];this.currentLine=e.split(""),this.currentLine.push("\n"),this.endOfFile=this.linePointer===this.lines.length}readPrevLine(){if(this.linePointer>0){var e=this.lines[--this.linePointer];this.currentLine=e.split(""),this.currentLine.push("\n")}}addError(e,t=null,s=null){let i=this.errorsDescription.getErrorTextByCode(e)+(null===t?"":". "+t),r=null===s?this.getCurrentPosition():s;throw new n(e,i,r)}printListing(e=null){let t=e.textPosition.lineNumber;for(let e=0;e<=t;e++)this.printer.listLine(this.lines[e],e);this.printer.listError(e);for(let e=t+1;e<=this.lines.length-1;e++)this.printer.listLine(this.lines[e],e)}readWords(e){this.reader.readWords(e)}}{constructor(e,t,s=null){super(t,s),this.setLines(e)}}const r={star:21,slash:60,equal:16,comma:20,semicolon:14,colon:5,point:61,arrow:62,leftPar:9,rightPar:4,lBracket:11,rBracket:12,flPar:63,frPar:64,later:65,greater:66,laterEqual:67,greaterEqual:68,laterGreater:69,plus:70,minus:71,lComment:72,rComment:73,assign:51,twoPoints:74,at:75,ident:2,floatC:82,intC:15,charC:83,stringC:84,booleanC:85,caseSy:31,elseSy:32,fileSy:57,gotoSy:33,thenSy:52,untilSy:53,doSy:54,withSy:37,ifSy:56,ofSy:102,orSy:103,inSy:104,toSy:105,endSy:106,varSy:107,divSy:108,andSy:109,notSy:110,forSy:111,modSy:112,nilSy:113,setSy:114,typeSy:120,realSy:121,charSy:122,beginSy:123,whileSy:124,arraySy:125,constSy:126,labelSy:127,downtoSy:128,stringSy:129,packedSy:130,recordSy:131,repeatSy:132,integerSy:133,booleanSy:134,programSy:135,functionSy:136,procedureSy:137,breakSy:138,trueSy:139,falseSy:140,plusAssign:141,minusAssign:142,slashAssign:143,starAssign:144};class a{constructor(){this.keyWordsCodes=new Map([["if",r.ifSy],["do",r.doSy],["of",r.ofSy],["or",r.orSy],["in",r.inSy],["to",r.toSy],["end",r.endSy],["var",r.varSy],["div",r.divSy],["and",r.andSy],["not",r.notSy],["for",r.forSy],["mod",r.modSy],["nil",r.nilSy],["set",r.setSy],["then",r.thenSy],["else",r.elseSy],["case",r.caseSy],["file",r.fileSy],["goto",r.gotoSy],["type",r.typeSy],["with",r.withSy],["real",r.realSy],["char",r.charSy],["true",r.trueSy],["exit",r.exitSy],["begin",r.beginSy],["break",r.breakSy],["while",r.whileSy],["array",r.arraySy],["const",r.constSy],["label",r.labelSy],["until",r.untilSy],["false",r.falseSy],["downto",r.downtoSy],["string",r.stringSy],["packed",r.packedSy],["record",r.recordSy],["repeat",r.repeatSy],["program",r.programSy],["integer",r.integerSy],["longint",r.longintSy],["boolean",r.booleanSy],["function",r.functionSy],["procedure",r.procedureSy]])}getSymbolCodeByKeyWord(e){let t=e.toLowerCase();return this.keyWordsCodes.has(t)?this.keyWordsCodes.get(t):r.ident}}class l{constructor(e,t,s,n){this.textPosition=e,this.symbolCode=t,this.stringValue=s,this.value=n}}class o extends l{constructor(e,t,s){super(e,t,s,s)}}class h extends l{constructor(e,t,s){super(e,t,s,parseFloat(s))}}class c extends l{constructor(e,t,s){super(e,t,s,Number.parseInt(s))}}class u extends l{constructor(e,t,s){super(e,t,s,s.replace(/'/g,""))}}class y extends l{constructor(e,t,s){super(e,t,s,s.replace(/'/g,""))}}class d extends l{constructor(e,t,s){super(e,t,s,"true"===s.toLowerCase())}}class p{constructor(e){this.fileIO=e,this.errorsCodes=t,this.token=null,this.currentWord=null,this.char=" ",this.symbol=null,this.MAX_IDENT=64,this.keyWords=new a,this.wordBuffer=null}nextSym(){return null===this.char?null:(this.skipWhiteSpaces(),this.token=this.fileIO.getCurrentPosition(),this.scanSymbol())}scanSymbol(){if(null===this.char)return null;if(null===this.wordBuffer?this.currentWord="":(this.currentWord=this.wordBuffer,this.wordBuffer=null),null!==/[a-z]/i.exec(this.char)){for(;null!==/\w/i.exec(this.char);)this.currentWord+=this.char,this.char=this.fileIO.nextCh();return this.getSymbol(this.keyWords.getSymbolCodeByKeyWord(this.currentWord))}if(null!==/[\d.]/.exec(this.char)){if(this.currentWord+=this.char,this.char=this.fileIO.nextCh(),".."===this.currentWord)return this.symbol=r.twoPoints,this.getSymbol(this.symbol);if("."===this.currentWord&&"."===this.char)return this.currentWord+=this.char,this.char=this.fileIO.nextCh(),this.getSymbol(r.twoPoints);if("."===this.currentWord&&null===/\d/.exec(this.char))return this.symbol=r.point,this.getSymbol(this.symbol);{let e="."===this.currentWord,t=null;for(;null!==/[\d.]/.exec(this.char);){if("."===this.char){if(e){if("."===t)return this.wordBuffer=".",new c(this.token,r.intC,this.currentWord);break}e=!0}t=this.char,this.currentWord+=this.char,this.char=this.fileIO.nextCh()}let s=0,n=!1,i="";if(/e/i.exec(this.char))if(n=!0,s++,i+=this.char,this.char=this.fileIO.nextCh(),/[\d+-]/.exec(this.char))if(/[+-]/.exec(this.char)&&(s++,i+=this.char,this.char=this.fileIO.nextCh()),/\d/.exec(this.char))for(;/\d/.exec(this.char);)s++,i+=this.char,this.char=this.fileIO.nextCh();else n=!1;else n=!1;if(n)this.currentWord+=i;else for(let e=1;e<=s;e++)this.char=this.fileIO.prevCh();return e||n?new h(this.token,r.floatC,this.currentWord):new c(this.token,r.intC,this.currentWord)}}switch(this.currentWord+=this.char,this.char){case":":return this.char=this.fileIO.nextCh(),"="===this.char?(this.currentWord+=this.char,this.char=this.fileIO.nextCh(),this.getSymbol(r.assign)):this.getSymbol(r.colon);case"<":switch(this.char=this.fileIO.nextCh(),this.char){case"=":return this.currentWord+=this.char,this.char=this.fileIO.nextCh(),this.getSymbol(r.laterEqual);case">":return this.currentWord+=this.char,this.char=this.fileIO.nextCh(),this.getSymbol(r.laterGreater);default:return this.getSymbol(r.later)}case">":return this.char=this.fileIO.nextCh(),"="===this.char?(this.currentWord+=this.char,this.char=this.fileIO.nextCh(),this.getSymbol(r.greaterEqual)):this.getSymbol(r.greater);case"-":return this.char=this.fileIO.nextCh(),"="===this.char?(this.currentWord+=this.char,this.char=this.fileIO.nextCh(),this.getSymbol(r.minusAssign)):this.getSymbol(r.minus);case"+":return this.char=this.fileIO.nextCh(),"="===this.char?(this.currentWord+=this.char,this.char=this.fileIO.nextCh(),this.getSymbol(r.plusAssign)):this.getSymbol(r.plus);case"*":return this.char=this.fileIO.nextCh(),"="===this.char?(this.currentWord+=this.char,this.char=this.fileIO.nextCh(),this.getSymbol(r.starAssign)):this.getSymbol(r.star);case"/":if(this.char=this.fileIO.nextCh(),"="===this.char)return this.currentWord+=this.char,this.char=this.fileIO.nextCh(),this.getSymbol(r.slashAssign);{let e=null;if("/"===this.char){do{e=this.fileIO.nextCh()}while("\n"!==e);return this.char=this.fileIO.nextCh(),this.skipWhiteSpaces(),this.scanSymbol()}return this.getSymbol(r.slash)}case"=":return this.char=this.fileIO.nextCh(),this.getSymbol(r.equal);case",":return this.char=this.fileIO.nextCh(),this.getSymbol(r.comma);case";":return this.char=this.fileIO.nextCh(),this.getSymbol(r.semicolon);case"^":return this.char=this.fileIO.nextCh(),this.getSymbol(r.arrow);case"(":this.char=this.fileIO.nextCh();var e=null,t=this.currentWord;if("*"===this.char){do{e=t,t=this.fileIO.nextCh()}while("*"!==e||")"!==t);return this.char=this.fileIO.nextCh(),this.skipWhiteSpaces(),this.scanSymbol()}return this.getSymbol(r.leftPar);case")":return this.char=this.fileIO.nextCh(),this.getSymbol(r.rightPar);case"[":return this.char=this.fileIO.nextCh(),this.getSymbol(r.lBracket);case"]":return this.char=this.fileIO.nextCh(),this.getSymbol(r.rBracket);case"{":let s=null;do{s=this.fileIO.nextCh()}while("}"!==s);return this.char=this.fileIO.nextCh(),this.skipWhiteSpaces(),this.scanSymbol();case"}":return this.char=this.fileIO.nextCh(),this.getSymbol(r.frPar);case"<":return this.char=this.fileIO.nextCh(),this.getSymbol(r.later);case">":return this.char=this.fileIO.nextCh(),this.getSymbol(r.greater);case"@":return this.char=this.fileIO.nextCh(),this.getSymbol(r.at);case"'":do{this.char=this.fileIO.nextCh(),this.currentWord+=this.char}while("'"!==this.char);return this.char=this.fileIO.nextCh(),3===this.currentWord.length?new u(this.token,r.charC,this.currentWord):new y(this.token,r.stringC,this.currentWord)}return this.addForbiddenCharacterError(this.char),this.char=this.fileIO.nextCh(),null}getSymbol(e){return e===r.trueSy||e===r.falseSy?new d(this.token,r.booleanC,this.currentWord):new o(this.token,e,this.currentWord)}skipWhiteSpaces(){for(;null!==/\s/.exec(this.char);)this.char=this.fileIO.nextCh()}addForbiddenCharacterError(e){this.fileIO.addError(this.errorsCodes.forbiddenCharacter,` '${e}'`,this.token)}}class m{constructor(){this.symbolCodeMapper=new Map([[r.star,"*"],[r.slash,"/"],[r.equal,"="],[r.comma,","],[r.semicolon,";"],[r.colon,":"],[r.point,"."],[r.arrow,"^"],[r.leftPar,"("],[r.rightPar,")"],[r.lBracket,"["],[r.rBracket,"]"],[r.flPar,"{"],[r.frPar,"}"],[r.later,"<"],[r.greater,">"],[r.laterEqual,"<="],[r.greaterEqual,">="],[r.laterGreater,"<>"],[r.plus,"+ "],[r.minus,"- "],[r.lComment,"(*"],[r.rComment,"*)"],[r.assign,":="],[r.twoPoints,".."],[r.ident,"Identifier"],[r.floatC,"Float Constant"],[r.intC,"Integer Constant"],[r.charC,"Character Constant"],[r.caseSy,"case"],[r.elseSy,"else"],[r.fileSy,"file"],[r.gotoSy,"goto"],[r.thenSy,"then"],[r.untilSy,"until"],[r.doSy,"do"],[r.withSy,"with"],[r.ifSy,"if"],[r.ofSy,"of"],[r.orSy,"or"],[r.inSy,"in"],[r.toSy,"to"],[r.endSy,"end"],[r.varSy,"var"],[r.divSy,"div"],[r.andSy,"and"],[r.notSy,"not"],[r.forSy,"for"],[r.modSy,"mod"],[r.nilSy,"nil"],[r.setSy,"set"],[r.typeSy,"type"],[r.realSy,"real"],[r.charSy,"char"],[r.exitSy,"exit"],[r.beginSy,"begin"],[r.whileSy,"while"],[r.arraySy,"array"],[r.constSy,"const"],[r.labelSy,"label"],[r.downtoSy,"downto"],[r.stringSy,"string"],[r.packedSy,"packed"],[r.recordSy,"record"],[r.repeatSy,"repeat"],[r.integerSy,"integer"],[r.programSy,"program"],[r.functionSy,"function"],[r.procedureSy,"procedure"]])}getSymbolTextByCode(e){return this.symbolCodeMapper.has(e)?this.symbolCodeMapper.get(e):null}}class f{constructor(e){this.symbol=e}}class b extends f{constructor(e,t,s){super(e),this.destination=t,this.sourceExpression=s}}class w extends f{constructor(e,t,s){super(e),this.identifier=t,this.indexRing=s}}class g extends f{constructor(e,t,s=null){super(e),this.indexExpression=t,this.indexRing=s,this.evaluatedIndexExpression=null}appendIndexRing(e){null===this.indexRing?this.indexRing=e:this.indexRing.appendIndexRing(e)}}class x extends f{constructor(e,t){super(e),this.pointer=t}}class S extends f{constructor(e,t){super(e),this.identifier=t}}class C extends f{constructor(e,t,s){super(e),this.baseExpression=t,this.subField=s}}class v extends f{constructor(e,t,s){super(e),this.left=t,this.right=s}}class I extends v{constructor(e,t,s){super(e,t,s)}}class E extends v{constructor(e,t,s){super(e,t,s)}}class V extends v{constructor(e,t,s){super(e,t,s)}}class k extends v{constructor(e,t,s){super(e,t,s)}}class T extends f{constructor(e,t){super(e),this.typeId=t}}class L extends T{constructor(e,t){super(e,t)}toString(){switch(this.typeId){case 6:return"boolean";case 2:return"char";case 0:return"integer";case 1:return"real";case 7:return"string"}}}class P extends L{constructor(e=null){super(e,6)}}class O extends L{constructor(e=null,t=7){super(e,t)}}class N extends O{constructor(e=null){super(e,2)}}class R extends L{constructor(e,t=null){super(e,t)}}class B extends R{constructor(e=null){super(e,0)}}class M extends R{constructor(e=null){super(e,1)}}class A extends f{constructor(e){switch(super(e),e.symbolCode){case r.intC:this.type=new B(null),this.typeId=0;break;case r.floatC:this.type=new M(null),this.typeId=1;break;case r.charC:this.type=new N(null),this.typeId=2;break;case r.stringC:this.type=new O(null),this.typeId=7;break;case r.booleanC:this.type=new P(null),this.typeId=6;break;case r.ident:this.typeId=5}}}class W extends f{constructor(e){super(e)}}class D extends f{constructor(e,t,s=[]){super(e),this.identifierBranch=t,this.parameters=s}}class $ extends B{constructor(e=null){super(e)}}class F extends T{constructor(e,t){super(e,4);let s=this;this.typesList={},t.forEach((e=>{let t=e.type;e.identifiers.forEach((e=>{let n=e.symbol.value;s.typesList[n]=t}))}))}toString(){let e=[],t=null;for(t in this.typesList)e.push(`${t}: `+this.typesList[t].toString());return`record(${e.join(", ")})`}}class q extends T{constructor(e){super(e,9)}toString(){return this.symbol.stringValue}}class j extends f{constructor(e,t,s,n){super(e),this.identifiers=t,this.variablesType=s,this.initialValue=n}}class z extends f{constructor(e,t,s,n=null){super(e),this.identifier=t,this.value=s,this.type=n}}class U extends f{constructor(e,t,s){super(e),this.identifier=t,this.type=s}}class G extends f{constructor(e){super(e),this.sentences=[]}}class _ extends f{constructor(e,t,s,n){super(e),this.condition=t,this.left=s,this.right=n}}class K extends v{constructor(e,t,s){super(e,t,s)}}class X extends v{constructor(e,t,s){super(e,t,s)}}class H extends v{constructor(e,t,s){super(e,t,s)}}class J extends v{constructor(e,t,s){super(e,t,s)}}class Q extends f{constructor(e,t){super(e),this.value=t}}class Y extends f{constructor(e,t){super(e),this.value=t}}class Z extends T{constructor(e=null,t=null,s=null,n=null){super(e,s),this.signature=t,this.returnType=n}}class ee extends Z{constructor(e,t=null,s=null){super(e,t,11,s)}toString(){let e=[];return this.signature.length>0&&this.signature.forEach((function(t,s){let n=t.identifiers.map((e=>e.symbol.stringValue)).join(", ");e[s]=n+": "+t.type.toString()})),`function(${e.join("; ")}): ${this.returnType.toString()}`}}class te{constructor(e=!1){this.byReference=e}}class se{constructor(e=null){this.parentFunctionsStore=e,this.items={}}addFunction(e,t){let s=e.toLowerCase();if(this.items.hasOwnProperty(s))if(Array.isArray(this.items[s]))this.items[s].push(t);else{let e=this.items[s];this.items[s]=[e,t]}else this.items[s]=t}getFunction(e,t,s=null,n=null){let i=[];if(null===s&&n instanceof ee){let e=n.signature;n=n.returnType,s=[];for(let t=0;t<e.length;t++)for(let n=0;n<e[t].identifiers.length;n++)s[t+n]=e[t].type,i[t+n]=e[t].byReference}let r=e.toLowerCase(),a=null;if(!this.items.hasOwnProperty(r))return this.parentFunctionsStore?this.parentFunctionsStore.getFunction(e,t,s):null;if(a=this.items[r],!a||Array.isArray(a)||a.type.signature instanceof te||null===s||(a=[a]),Array.isArray(a)){let r=a.filter((e=>{let r=e.type.signature,a=e.type.returnType;if(r.map((e=>e.identifiers.length)).reduce(((e,t)=>e+t),0)!==(null===s?0:s.length))return!1;let l=[],o=[],h=0;for(let e=0;e<r.length;e++)for(let t=0;t<r[e].identifiers.length;t++)l[h]=r[e].type,o[h]=r[e].byReference,h++;if(null!==a&&null!==n&&!n instanceof Z&&!t.checkType(a,n))return!1;for(let e=0;e<l.length;e++)if(!t.checkType(l[e],s[e])||o.length>0&&i.length>0&&o[e]!==i[e])return!1;return!0}));return r.length>0?r[0]:this.parentFunctionStore?this.parentFunctionsStore.getFunction(e,t,s):null}return a}}class ne extends f{constructor(e,t=null){super(e),this.name=null,this.vars=[],this.functionsStore=new se(t instanceof ne?t.functionsStore:null),this.sentences=[],this.types=[],this.constants=[],this.parentFunction=t,this.exit=!1}getType(){return this.type}}class ie extends ne{constructor(e){super(e)}}class re extends ne{constructor(e,t=null,s=null){super(e,s),this.type=t}}class ae extends ne{constructor(e,t=null,s=null){super(e,s),this.type=t}}class le extends v{constructor(e,t,s){super(e,t,s)}}class oe extends v{constructor(e,t,s){super(e,t,s)}}class he extends v{constructor(e,t,s){super(e,t,s)}}class ce extends v{constructor(e,t,s){super(e,t,s)}}class ue extends v{constructor(e,t,s){super(e,t,s)}}class ye extends v{constructor(e,t,s){super(e,t,s)}}class de extends v{constructor(e,t,s){super(e,t,s)}}class pe extends Z{constructor(e,t){super(e,t,10)}toString(){let e=[];return this.signature.length>0&&this.signature.forEach((function(t,s){let n=t.identifiers.map((e=>e.symbol.stringValue)).join(", ");e[s]=n+": "+t.type.toString()})),`procedure(${e.join("; ")})`}}class me extends f{constructor(e,t=!1,s=null,n=[]){super(e),this.byReference=t,this.type=s,this.identifiers=n}}class fe{constructor(e,t=[]){this.leftBraceSymbol=e,this.items=t}}class be{constructor(e,t={}){this.leftBraceSymbol=e,this.items=t}}class we extends T{constructor(e){super(e,5),this.items=[]}toString(){return`enum(${this.items.map((e=>e.symbol.stringValue)).join(", ")})`}}class ge extends T{constructor(e,t=null,s=null,n=null){super(e,3),this.typeOfElements=n,this.leftIndex=t,this.rightIndex=s}toString(){return`array [${this.leftIndex.symbol.value}..${this.rightIndex.symbol.value}] of ${this.typeOfElements}`}}class xe extends T{constructor(e,t){super(e,8),this.type=t}toString(){return`^${this.type}`}}class Se extends f{constructor(e,t,s){super(e),this.condition=t,this.body=s}}class Ce extends f{constructor(e,t,s){super(e),this.condition=t,this.body=s}}class ve extends f{constructor(e,t=null,s=[],n=null){super(e),this.switchExpression=t,this.cases=s,this.elseSentence=n}}class Ie extends f{constructor(e,t=[],s=null){super(e),this.constants=t,this.operator=s}}class Ee extends f{constructor(e,t,s,n,i,r){super(e),this.variableIdentifier=t,this.initExpression=s,this.lastExpression=n,this.countDown=i,this.body=r}}class Ve extends f{constructor(e){super(e)}}class ke extends f{constructor(e,t){super(e),this.exitExpression=t}}class Te{constructor(e){this.lexicalAnalyzer=e,this.symbolsDescription=new m,this.symbol=null,this.tree=null,this.trees=[],this.treesCounter=0,this.errorDetected=!1}nextSym(){this.symbol=this.lexicalAnalyzer.nextSym()}anotherSymbolExpected(e){let s=`'${this.symbolsDescription.getSymbolTextByCode(e)}' expected but '${null===this.symbol?"end of file":this.symbol.stringValue}' found.`;this.lexicalAnalyzer.fileIO.addError(t.inadmissibleSymbol,s,null===this.symbol?this.lexicalAnalyzer.fileIO.getCurrentPosition():this.symbol.textPosition)}accept(e){null!==this.symbol&&this.symbol.symbolCode===e?this.nextSym():(this.errorDetected=!0,this.anotherSymbolExpected(e),this.goToEnd())}analyze(){return this.tree=new ie(this.symbol),this.trees[this.treesCounter]=this.tree,this.nextSym(),this.scanProgramme(),this.tree}scanProgramme(){this.symbol.symbolCode===r.programSy&&(this.nextSym(),this.tree.name=this.symbol.stringValue,this.accept(r.ident),this.accept(r.semicolon)),this.scanBlock(),this.accept(r.point)}scanBlock(){for(;null!==this.symbol&&this.symbol.symbolCode!==r.beginSy;)switch(this.symbol.symbolCode){case r.constSy:this.constPart();break;case r.typeSy:this.typePart();break;case r.varSy:this.varPart();break;case r.procedureSy:this.scanProcedure();break;case r.functionSy:this.scanFunction();break;default:let e=`Symbol 'begin' expecsted but '${this.symbol.stringValue}' found.`;this.addError(t.inadmissibleSymbol,e,this.symbol)}this.statementPart()}constPart(){if(this.symbol.symbolCode===r.constSy){this.nextSym();do{let e=this.symbol;this.accept(r.ident);let t=null;this.symbol.symbolCode===r.colon&&(this.nextSym(),t=this.scanType());let s=this.symbol;this.accept(r.equal);let n=this.scanConstant(),i=new z(s,new W(e),n,t);this.tree.constants.push(i),this.accept(r.semicolon)}while(this.symbol.symbolCode===r.ident)}}typePart(){if(this.symbol.symbolCode===r.typeSy){this.nextSym();do{let e=this.symbol;this.accept(r.ident);let t=this.symbol;this.accept(r.equal);let s=this.scanType(),n=new U(t,new W(e),s);this.tree.types.push(n),this.accept(r.semicolon)}while(this.symbol.symbolCode===r.ident)}}varPart(){if(this.symbol.symbolCode===r.varSy){this.nextSym();do{this.tree.vars.push(this.scanVarDeclaration()),this.accept(r.semicolon)}while(!this.errorDetected&&this.symbol.symbolCode===r.ident)}}scanVarDeclaration(){let e=[],t=null,s=!1;do{t=new W(this.symbol),this.accept(r.ident),e.push(t),s=this.symbol.symbolCode===r.comma,s&&this.nextSym()}while(!this.errorDetected&&s);let n=this.symbol;this.accept(r.colon);let i=this.scanType(),a=null;return this.symbol.symbolCode===r.equal&&(this.nextSym(),a=this.scanConstant()),new j(n,e,i,a)}scanListArrayType(e){let t=null,s=this.scanConstant();this.accept(r.twoPoints);let n=this.scanConstant();return this.symbol.symbolCode===r.comma?(e=this.symbol,this.nextSym(),t=this.scanListArrayType()):(this.accept(r.rBracket),this.accept(r.ofSy),t=this.scanType()),new ge(e,s,n,t)}scanType(){let e=null;if(this.symbol.symbolCode===r.arrow){e=this.symbol,this.nextSym();let t=this.scanType();return new xe(e,t)}if(this.symbol.symbolCode===r.integerSy||this.symbol.symbolCode===r.longintSy||this.symbol.symbolCode===r.booleanSy||this.symbol.symbolCode===r.realSy||this.symbol.symbolCode===r.stringSy||this.symbol.symbolCode===r.charSy)switch(e=this.symbol,this.nextSym(),e.symbolCode){case r.charSy:return new N(e);case r.integerSy:return new B(e);case r.stringSy:return new O(e);case r.realSy:return new M(e);case r.booleanSy:return new P(e);case r.longintSy:return new $(e)}else{if(this.symbol.symbolCode===r.ident)return e=this.symbol,this.nextSym(),new q(e);if(this.symbol.symbolCode===r.arraySy)return e=this.symbol,this.nextSym(),this.accept(r.lBracket),this.scanListArrayType(e);if(this.symbol.symbolCode===r.leftPar){let e=new we(this.symbol),t=null;do{this.nextSym(),t=new W(this.symbol),e.items.push(t),this.accept(r.ident)}while(this.symbol.symbolCode===r.comma);return this.accept(r.rightPar),e}if(this.symbol.symbolCode===r.functionSy){let e=new ee(this.symbol);return this.nextSym(),e.signature=this.scanParametersList(),this.accept(r.colon),e.returnType=this.scanType(),e}if(this.symbol.symbolCode===r.procedureSy){let e=new pe(this.symbol);return this.nextSym(),e.signature=this.scanParametersList(),e}if(this.symbol.symbolCode===r.recordSy){let e=this.symbol;this.nextSym();let t=[];do{if(t.length>0&&(this.symbol.symbolCode===r.semicolon&&this.nextSym(),this.symbol.symbolCode===r.endSy))break;let e=new me(this.symbol),s=[];do{s.length>0&&this.symbol.symbolCode===r.comma&&this.nextSym(),s.push(new W(this.symbol)),this.accept(r.ident)}while(this.symbol.symbolCode===r.comma);this.accept(r.colon),e.identifiers=s,e.type=this.scanType(),t.push(e)}while(this.symbol.symbolCode===r.semicolon);return this.accept(r.endSy),new F(e,t)}}}scanProcedure(){let e=this.symbol;this.accept(r.procedureSy);let t=new W(this.symbol);this.accept(r.ident);let s=new pe(e);s.signature=this.scanParametersList();let n=this.tree;this.treesCounter++,this.tree=new re(e,s,n),this.trees[this.treesCounter]=this.tree,this.tree.name=t;let i=this.tree.name.symbol.value.toLowerCase();this.tree.signature=this.scanParametersList(),this.accept(r.semicolon),this.scanBlock(),this.accept(r.semicolon),this.trees[this.treesCounter-1].functionsStore.addFunction(i,this.tree),this.treesCounter--,this.tree=this.trees[this.treesCounter]}scanFunction(){let e=this.symbol;this.accept(r.functionSy);let t=new W(this.symbol);this.accept(r.ident);let s=new ee(e);s.signature=this.scanParametersList(),this.accept(r.colon),s.returnType=this.scanType();let n=this.tree;this.treesCounter++,this.tree=new ae(e,s,n),this.trees[this.treesCounter]=this.tree,this.tree.name=t;let i=this.tree.name.symbol.value.toLowerCase();this.accept(r.semicolon),this.scanBlock(),this.accept(r.semicolon),this.trees[this.treesCounter-1].functionsStore.addFunction(i,this.tree),this.treesCounter--,this.tree=this.trees[this.treesCounter]}scanParametersList(){let e=[];if(this.symbol.symbolCode===r.leftPar){if(this.nextSym(),this.symbol.symbolCode!==r.rightPar)do{e.length>0&&this.symbol.symbolCode===r.semicolon&&this.nextSym();let t=!1;this.symbol.symbolCode===r.varSy&&(t=!0,this.nextSym());let s=new me(this.symbol,t),n=[];do{n.length>0&&this.symbol.symbolCode===r.comma&&this.nextSym(),n.push(new W(this.symbol)),this.accept(r.ident)}while(this.symbol.symbolCode===r.comma);this.accept(r.colon),s.identifiers=n,s.type=this.scanType(),e.push(s)}while(this.symbol.symbolCode===r.semicolon);this.accept(r.rightPar)}return e}statementPart(){for(this.accept(r.beginSy);null!==this.symbol&&this.symbol.symbolCode!==r.endSy;){let e=this.scanSentence();this.tree.sentences.push(e),this.symbol.symbolCode!==r.endSy&&this.accept(r.semicolon)}this.accept(r.endSy)}goToEnd(){do{this.nextSym()}while(null!==this.symbol)}scanSentence(){if(this.symbol.symbolCode===r.ident){let e=this.scanIdentifierBranch();if(this.symbol.symbolCode===r.assign||this.symbol.symbolCode===r.plusAssign||this.symbol.symbolCode===r.minusAssign||this.symbol.symbolCode===r.starAssign||this.symbol.symbolCode===r.slashAssign){let t=this.symbol;return this.nextSym(),new b(t,e,this.scanExpression())}return e}if(this.symbol.symbolCode===r.beginSy)return this.scanCompoundOperator();if(this.symbol.symbolCode===r.ifSy){let e=this.symbol;this.nextSym();let t=this.scanExpression();this.accept(r.thenSy);let s=this.scanSentence(),n=null;return this.symbol.symbolCode===r.elseSy&&(this.nextSym(),n=this.scanSentence()),new _(e,t,s,n)}if(this.symbol.symbolCode===r.whileSy){let e=this.symbol;this.nextSym();let t=this.scanExpression();this.accept(r.doSy);let s=this.scanSentence();return new Se(e,t,s)}if(this.symbol.symbolCode===r.repeatSy){let e=this.symbol,t=new G(e);for(this.nextSym();null!==this.symbol&&this.symbol.symbolCode!==r.untilSy;){let e=this.scanSentence();t.sentences.push(e),this.symbol.symbolCode!==r.untilSy&&this.accept(r.semicolon)}this.accept(r.untilSy);let s=t,n=this.scanExpression();return new Ce(e,n,s)}if(this.symbol.symbolCode===r.forSy){let e=this.symbol;this.nextSym();let s=this.symbol;this.accept(r.ident);let n=new W(s);this.symbol,this.accept(r.assign);let i=this.scanSimpleExpression(),a=!1;switch(this.symbol.symbolCode){case r.downtoSy:a=!0;break;case r.toSy:a=!1;break;default:let e=`Symbols 'to' or 'downto' expected but '${this.symbol.stringValue}' found.`;this.addError(t.inadmissibleSymbol,e,this.symbol)}this.nextSym();let l=this.scanSimpleExpression();this.accept(r.doSy);let o=this.scanSentence();return new Ee(e,n,i,l,a,o)}if(this.symbol.symbolCode===r.breakSy){let e=this.symbol;return this.nextSym(),new Ve(e)}if(this.symbol.symbolCode===r.exitSy){let e=this.symbol;this.nextSym();let t=null;return this.symbol.symbolCode===r.leftPar&&(this.nextSym(),this.symbol.symbolCode!==r.rightPar&&(t=this.scanExpression()),this.accept(r.rightPar)),new ke(e,t)}if(this.symbol.symbolCode===r.caseSy){let e=this.symbol;this.nextSym();let t=this.scanExpression();this.accept(r.ofSy);let s=new ve(e,t);do{let e=new Ie(this.symbol),t=null;do{e.constants.push(this.scanConstant()),t=this.symbol.symbolCode===r.comma,t&&this.nextSym()}while(t);this.accept(r.colon),e.operator=this.scanSentence(),s.cases.push(e),this.symbol.symbolCode!==r.endSy&&this.symbol.symbolCode!==r.elseSy?this.accept(r.semicolon):this.symbol.symbolCode===r.semicolon&&this.nextSym()}while(this.symbol.symbolCode!==r.endSy&&this.symbol.symbolCode!==r.elseSy);return this.symbol.symbolCode===r.elseSy&&(this.nextSym(),s.elseSentence=this.scanSentence(),this.symbol.symbolCode===r.semicolon&&this.accept(r.semicolon)),this.accept(r.endSy),s}}scanCompoundOperator(){let e=new G(this.symbol);for(this.accept(r.beginSy);null!==this.symbol&&this.symbol.symbolCode!==r.endSy;){let t=this.scanSentence();e.sentences.push(t),this.symbol.symbolCode!==r.endSy&&this.accept(r.semicolon)}return this.accept(r.endSy),e}scanIndicesBrackets(e){this.accept(r.lBracket);let t=new g(e,this.scanExpression());for(;this.symbol.symbolCode===r.comma;){let e=this.symbol;this.nextSym();let s=new g(e,this.scanExpression());t.appendIndexRing(s)}return this.accept(r.rBracket),t}scanIndices(e){this.symbol;let t=this.scanIndicesBrackets(this.symbol);for(;this.symbol.symbolCode===r.lBracket;){let e=this.symbol,s=this.scanIndicesBrackets(e);t.appendIndexRing(s)}return t}scanIdentifierBranch(e=null){let t=null;if(null===e){let e=this.symbol;this.nextSym(),t=new W(e)}else t=e;switch(this.symbol.symbolCode){case r.leftPar:let e=this.symbol;this.nextSym();let s=this.scanParameters();return this.scanIdentifierBranch(new D(e,t,s));case r.lBracket:let n=this.symbol;return this.scanIdentifierBranch(new w(n,t,this.scanIndices()));case r.point:let i=this.symbol;this.nextSym();let a=new W(this.symbol);return this.accept(r.ident),this.scanIdentifierBranch(new C(i,t,a));case r.arrow:let l=this.symbol;return this.nextSym(),this.scanIdentifierBranch(new x(l,t));default:return t}}scanExpression(){if(this.symbol.symbolCode===r.at){let e=this.symbol;this.nextSym();let t=this.symbol;this.accept(r.ident);let s=new W(t),n=this.scanIdentifierBranch(s);return new S(e,n)}let e=this.scanSimpleExpression();switch(this.symbol.symbolCode){case r.equal:return this.nextSym(),new oe(this.symbol,e,this.scanSimpleExpression());case r.later:return this.nextSym(),new ce(this.symbol,e,this.scanSimpleExpression());case r.greater:return this.nextSym(),new ue(this.symbol,e,this.scanSimpleExpression());case r.laterGreater:return this.nextSym(),new he(this.symbol,e,this.scanSimpleExpression());case r.laterEqual:return this.nextSym(),new de(this.symbol,e,this.scanSimpleExpression());case r.greaterEqual:return this.nextSym(),new ye(this.symbol,e,this.scanSimpleExpression());case r.inSy:return this.nextSym(),new le(this.symbol,e,this.scanSimpleExpression());default:return e}}scanSimpleExpression(){let e=this.scanTerm();for(;null!==this.symbol&&(this.symbol.symbolCode===r.plus||this.symbol.symbolCode===r.minus||this.symbol.symbolCode===r.orSy);)switch(this.symbol.symbolCode){case r.plus:this.nextSym(),e=new V(this.symbol,e,this.scanTerm());break;case r.minus:this.nextSym(),e=new k(this.symbol,e,this.scanTerm());break;case r.orSy:this.nextSym(),e=new J(this.symbol,e,this.scanTerm())}return e}scanTerm(){let e=this.scanMultiplier(),t=null;for(;[r.star,r.slash,r.divSy,r.modSy,r.andSy].includes(this.symbol.symbolCode);)switch(t=this.symbol.symbolCode,this.nextSym(),t){case r.star:e=new I(this.symbol,e,this.scanMultiplier());break;case r.slash:e=new E(this.symbol,e,this.scanMultiplier());break;case r.divSy:e=new K(this.symbol,e,this.scanMultiplier());break;case r.modSy:e=new X(this.symbol,e,this.scanMultiplier());break;case r.andSy:e=new H(this.symbol,e,this.scanMultiplier())}return e}scanMultiplier(){let e=null;switch(this.symbol.symbolCode){case r.minus:return e=this.symbol,this.nextSym(),new Q(e,this.scanMultiplier());case r.plus:return this.nextSym(),this.scanMultiplier();case r.notSy:return e=this.symbol,this.nextSym(),new Y(e,this.scanMultiplier())}if(this.symbol.symbolCode===r.ident)return this.scanIdentifierBranch();if(this.symbol.symbolCode===r.floatC||this.symbol.symbolCode===r.intC||this.symbol.symbolCode===r.stringC||this.symbol.symbolCode===r.charC||this.symbol.symbolCode===r.booleanC)return this.scanUnsignedConstant();if(this.symbol.symbolCode===r.leftPar){this.nextSym();let e=this.scanExpression();return this.accept(r.rightPar),e}{let e=`Multiplier expression expected but '${this.symbol.stringValue}' found.`;this.addError(t.inadmissibleSymbol,e,this.symbol)}}scanParameters(){let e=[];if(this.symbol.symbolCode!==r.rightPar)do{e.length>0&&this.symbol.symbolCode===r.comma&&this.nextSym(),e.push(this.scanExpression())}while(this.symbol.symbolCode===r.comma);return this.accept(r.rightPar),e}scanUnsignedConstant(){let e=null;switch(this.symbol.symbolCode){case r.floatC:case r.intC:case r.charC:case r.stringC:case r.booleanC:e=new A(this.symbol),this.nextSym()}return e}scanConstant(){let e=!1,s=null;switch(this.symbol.symbolCode){case r.minus:s=this.symbol,this.nextSym(),e=!0;break;case r.plus:s=this.symbol,this.nextSym()}let n=null,i=this.symbol.symbolCode;switch(i){case r.floatC:case r.intC:case r.charC:case r.stringC:case r.booleanC:case r.ident:n=new A(this.symbol),this.nextSym();break;case r.leftPar:n=this.scanTuple()}if(e)switch(i){case r.floatC:case r.intC:let e=n.symbol.value;n.symbol.value=-e;break;default:this.addError(t.typesMismatch,"Using unary minus with non-numeric values",s)}return n}scanTuple(){let e=this.symbol;this.accept(r.leftPar);let t=null,s=null,n=!1;if(this.symbol.symbolCode===r.ident?(t=this.symbol,this.nextSym(),this.symbol.symbolCode===r.comma||this.symbol.symbolCode===r.rightPar?s=t:this.symbol.symbolCode===r.colon?(this.nextSym(),n=!0,s=this.scanConstant()):this.anotherSymbolExpected(r.colon)):s=this.scanConstant(),n){let n={};for(null!==t&&(n[t.value.toLowerCase()]=s);this.symbol.symbolCode!==r.rightPar;)this.accept(r.semicolon),t=this.symbol,this.accept(r.ident),this.accept(r.colon),s=this.scanConstant(),n[t.value.toLowerCase()]=s;return this.nextSym(),new be(e,n)}{let t=[];for(t.push(s);this.symbol.symbolCode!==r.rightPar;)this.accept(r.comma),s=this.scanConstant(),t.push(s);return this.nextSym(),new fe(e,t)}}addError(e,t=null,s){this.lexicalAnalyzer.fileIO.addError(e,t,s.textPosition)}}class Le{constructor(){this.type=null,this.typeId=null}getType(){return this.type?this.type:this.typeId}}class Pe extends Le{constructor(e,t){if(super(),this.value=e,this.typeId=t,t instanceof L)this.type=t;else switch(t){case 6:this.type=new P(null);break;case 2:this.type=new N(null);break;case 0:this.type=new B(null);break;case 1:this.type=new M(null);break;case 7:this.type=new O(null)}}clone(){return new Pe(this.value,this.typeId)}}class Oe extends Le{constructor(e,t=null){super(),this.typeId=12,this.variableType=e,this.valueType=t,this.type=e}clone(){return new Oe(this.valueType,this.type.type)}}class Ne extends Le{constructor(e,t){super(),this.value=e,this.typeId=5,this.type=t}getIndex(){let e=this.type.items.length;for(let t=0;t<e;t++)if(this.type.items[t].symbol.stringValue.toLowerCase()===this.value.symbol.stringValue.toLowerCase())return t}clone(){return new Ne(this.value,this.type)}}class Re extends Le{constructor(e,t){super(),this.typeId=3,this.type=e,this.scope=t,this.items=[],this.leftIntegerIndex=0,this.rightIntegerIndex=null,this.offset=null,this.arrayLength=null}setValue(e,t,s){let n=e.evaluatedIndexExpression,i=this.scope.getIntegerValueOfIndexVariable(n)+this.offset;void 0===this.items[i]&&(this.items[i]=this.scope.createVariable(this.type.typeOfElements,s));let r=this.items[i];null===e.indexRing?r.value=s.value:e.indexRing instanceof g&&r.setValue(e.indexRing,t,s)}setInitialValueByInnerIndex(e,s,n){if(e<0||e>=this.arrayLength)this.scope.addError(t.indexIsOutOfRange,"",e);else if(void 0===this.items[e]){let t=n instanceof fe||n instanceof be?n:n.symbol.value,s=this.type.typeOfElements;this.items[e]=this.scope.createVariable(s,t)}}setArrayTuple(e){let t=this;e.items.forEach(((e,s)=>{t.setInitialValueByInnerIndex(s,t.type.typeOfElements,e)}))}getByIndexRing(e){let t=e.evaluatedIndexExpression,s=this.scope.getIntegerValueOfIndexVariable(t)+this.offset;void 0===this.items[s]&&(this.items[s]=this.scope.createDefaultVariable(this.type.typeOfElements));let n=this.items[s];return e.indexRing instanceof g?n.getByIndexRing(e.indexRing):n}clone(){let e=new Re(this.type,this.scope);return e.rightIntegerIndex=this.rightIntegerIndex,e.offset=this.offset,e.arrayLength=this.arrayLength,this.items.forEach(((t,s)=>{e.items[s]=t.clone()})),e}}class Be extends Le{constructor(e,t){super(),this.typeId=8,this.type=new xe(null,t),this.variable=e}clone(){return new Be(this.variable,this.type)}}class Me extends Le{constructor(e,t){super(),this.typeId=4,this.type=e,this.items={},this.scope=t}setPropertyByPropertyIdentifier(e,s){let n=e.symbol.value;this.type.typesList.hasOwnProperty(n)?this.items[n]=s:this.scope.addError(t.indexIsOutOfRange,`Property ${n} is not defined.`,e)}getByPropertyIdentifier(e){let s=e.symbol.value;if(this.type.typesList.hasOwnProperty(s)){if(!this.items.hasOwnProperty(s)){let e=this.type.typesList[s];this.items[s]=this.scope.createDefaultVariable(e)}return this.items[s]}this.scope.addError(t.indexIsOutOfRange,`Property ${s} is not defined.`,e)}setPropertyByName(e,t,s){let n=s instanceof fe||s instanceof be?s:s.symbol.value;this.items[e]=this.scope.createVariable(t,n)}setRecordTuple(e){let t=this.type.typesList,s=e.items;for(let[e,n]of Object.entries(t))s.hasOwnProperty(e.toLowerCase())&&this.setPropertyByName(e.toLowerCase(),n,s[e])}clone(){let e=new Me(this.type,this.scope),t=null;for(t in this.items)e.items[t]=this.items[t].clone(this.scope);return e}}class Ae extends Le{constructor(e,t=null){super(),this.type=e,this.typeId=e.typeId,this.value=t}clone(){return new Ae(this.type,this.value)}}class We extends ne{constructor(e=null){super(e),this.vars=[],this.signature=[],this.sentences=[],this.name=null}async innerRun(){}}class De extends We{constructor(e=null){super(),this.name=e}}class $e extends f{constructor(e=null,t=null){super(e),this.typeId=t}}class Fe{constructor(e=null){this.type=e}}class qe extends $e{constructor(e=null){super(null,null)}}class je extends $e{constructor(){super(null,null)}}class ze{constructor(e=null){this.parentScope=e,this.items={},this.constants={},this.enumsItems={},this.types={},this.cycleDepth=0,this.errorsDescription=new s,this.parametersList=null,this.callableName=null}addVariable(e,s,n=null,i=null,r=!1){let a=(e instanceof W?e.symbol.value:e).toLowerCase();if(this.constants.hasOwnProperty(a))this.addError(t.identifierAlreadyUsed,`Constant '${a}' declared.`,null===i?s:i);else if(this.items.hasOwnProperty(a))this.addError(t.identifierAlreadyUsed,`Variable '${a}' already declared.`,null===i?s:i);else{let e=this.createVariable(s,n);this.items[a]=e,r&&(this.items.result=e)}}createVariable(e,t=null){let s=this.resolveNamedType(e);if(s instanceof L){if(null===t)switch(s.typeId){case 0:case 1:t=0;break;case 2:t=String.fromCharCode(0);break;case 7:t="";break;case 6:t=!1}return new Pe(t,s.typeId)}if(s instanceof we)return null===t&&(t=s.items[0]),new Ne(t,s);if(s instanceof ge)return this.createArrayVariable(e,t);if(s instanceof xe){let s=this.resolveNamedType(e.type);return new Be(t,s)}if(s instanceof ee||s instanceof pe)return this.createDefaultVariable(s);if(s instanceof F){let e=this.createDefaultVariable(s);return t instanceof be&&e.setRecordTuple(t),e}return s instanceof Fe?new Oe(s.type,t):void 0}getIntegerValueOfIndexConstant(e){if(e instanceof A)switch(e.typeId){case 0:return e.symbol.value;case 2:return e.symbol.value.charCodeAt(0);case 5:return this.getEnumElement(e).getIndex()}else if(e instanceof Q){let s=e.value;if(s instanceof A&&0===s.typeId)return-s.symbol.value;this.addError(t.typesMismatch,"Integer constant expected after unary minus.",s)}}getIntegerValueOfIndexVariable(e){switch(e.typeId){case 0:return e.value;case 2:return e.value.charCodeAt(0);case 5:return this.getEnumElement(e.value).getIndex()}}createArrayVariable(e,t){let s=this.resolveNamedType(e),n=new Re(s,this),i=s.leftIndex,r=s.rightIndex,a=this.getIntegerValueOfIndexConstant(i),l=this.getIntegerValueOfIndexConstant(r),o=Math.min(a,l),h=Math.max(a,l),c=-o;return n.offset=c,n.arrayLength=h-o+1,n.leftIntegerIndex=0,n.rightIntegerIndex=h,n.rightIntegerIndex=h,t instanceof fe&&n.setArrayTuple(t),n}resolveNamedType(e){if(e instanceof q){let t=e.symbol.stringValue,s=this.getType(t,e);return this.resolveNamedType(s)}return e}setValue(e,s,n,i=null){let r=n instanceof Pe||n instanceof Ne||n instanceof Ae?n.value:n,a=null;e instanceof W?a=e:e instanceof w&&(a=e.identifier);let l=a.symbol.stringValue.toLowerCase();if(this.items.hasOwnProperty(l)){let n=this.items[l];if(n instanceof Pe||n instanceof Ne||n instanceof Ae)this.sameType(n.getType(),s)?this.items[l].value=r:this.addTypeMismatchError(s,n,i);else if(n instanceof Re){let t=null;if(e instanceof W)if(r instanceof fe)n.setArrayTuple(r);else if(t=n.type,this.sameType(s,t)){let e=r.clone();n.items=e.items}else this.addTypeMismatchError(s,n,i);else if(e instanceof w){let a=e.indexRing;t=this.getDestinationType(n.type,a),this.sameType(s,t)?(r instanceof Re&&(r=r.clone()),n.setValue(a,s,r)):this.addTypeMismatchError(s,n,i)}}else if(n instanceof Me)if(r instanceof be)n.setRecordTuple(r);else{let e=r.clone();n.items=e.items}else n instanceof Be&&s instanceof xe?this.sameType(n.type,s)?n.variable=r.variable:this.addTypeMismatchError(s,n,i):n instanceof Oe&&s instanceof Fe?this.typeIncluded(n.variableType,r.valueType)?n.valueType=r.valueType:this.addTypeMismatchError(n.variableType,r,i):this.addError(t.typesMismatch,null,i)}else this.parentScope?this.parentScope.setValue(e,s,r,i):this.addError(t.variableNotDeclared,`Variable '${l}' not declared.`,i)}setVariableValue(e,s,n=null){let i=s.type,r=null;e instanceof W?r=e:e instanceof w&&(r=e.identifier);let a=r.symbol.stringValue.toLowerCase();if(this.items.hasOwnProperty(a)){let r=this.items[a];if((r instanceof Pe||r instanceof Ne||r instanceof Ae||r instanceof Re&&e instanceof W||r instanceof Me)&&(this.typeIncluded(r.type,i)||this.addTypeMismatchError(i,r,n)),r instanceof Pe||r instanceof Ne||r instanceof Ae)this.items[a].value=s.value;else if(r instanceof Re){if(e instanceof W){let e=s.clone();r.items=e.items}else if(e instanceof w){let t=e.indexRing,a=this.getDestinationType(r.type,t);this.checkType(i,a)?(s=s.clone(),r.setValue(t,i,s)):this.addTypeMismatchError(i,r,n)}}else if(r instanceof Me){let e=s.clone();r.items=e.items}else r instanceof Be&&i instanceof xe?this.sameType(r.type,i)?r.variable=s.variable:this.addTypeMismatchError(i,r,n):this.addError(t.typesMismatch,null,n)}else this.parentScope?this.parentScope.setVariableValue(e,s,n):this.addError(t.variableNotDeclared,`Variable '${a}' not declared.`,n)}setRecordVariableProperty(e,s,n){let i=n.getType(),r=e.getByPropertyIdentifier(s);this.sameType(r.getType(),i)||this.addTypeMismatchError(i,r,s),r instanceof Pe||r instanceof Ne||r instanceof Ae?r.value=n.value:r instanceof Re||r instanceof Me?e.setPropertyByPropertyIdentifier(s,n.clone()):this.addError(t.typesMismatch,null,s)}setVariableObject(e,t){let s=e.symbol.stringValue.toLowerCase();this.items[s]=t}addTypeMismatchError(e,s,n){let i=Number.isInteger(e)?new L(null,e):e,r=!1===s.type?new L(null,s.typeId):s.type;this.addError(t.typesMismatch,`Type ${r} expected but ${i} found.`,n)}getDestinationType(e,t){return e instanceof ge&&t&&null!==t?this.getDestinationType(e.typeOfElements,t.indexRing):e}getVariable(e){let t=e.toLowerCase();return this.items.hasOwnProperty(t)?this.items[t]:this.parentScope?this.parentScope.getVariable(e):null}getElementByIdentifier(e){if(e instanceof W){let t=e.symbol.value.toLowerCase();if(this.types.hasOwnProperty(t)){let e=this.types[t];return new Oe(e,e)}return this.constants.hasOwnProperty(t)?this.constants[t]:this.items.hasOwnProperty(t)?this.items[t]:this.enumsItems.hasOwnProperty(t)?this.enumsItems[t]:this.parentScope?this.parentScope.getElementByIdentifier(e):null}}getEnumElement(e){let s=e.symbol.value.toLowerCase();if(this.enumsItems.hasOwnProperty(s))return this.enumsItems[s];this.addError(t.variableNotDeclared,`Enum element '${s}' not declared.`,e)}sameType(e,t){let s=e instanceof q?this.resolveNamedType(e):e,n=t instanceof q?this.resolveNamedType(t):t;if(s instanceof L)return s.typeId===n.typeId;if(s.constructor!==n.constructor)return!1;if(s instanceof we)return Object.is(s,n);if(s instanceof ee||s instanceof pe){let e=this.getParametersArray(s),t=this.getParametersArray(n);return e.length===t.length&&(!(s instanceof ee)||this.sameType(s.returnType,n.returnType))}if(s instanceof ge)return this.sameType(s.typeOfElements,n.typeOfElements)&&s.leftIndex.symbol.value===n.leftIndex.symbol.value&&s.rightIndex.symbol.value===n.rightIndex.symbol.value;if(s instanceof xe)return this.sameType(s.type,n.type);if(s instanceof F){let e=Object.keys(s.typesList).length===Object.keys(n.typesList).length,t=null;for(t in s.typesList){if(!e)return!1;e=e&&n.typesList.hasOwnProperty(t)&&this.sameType(s.typesList[t],n.typesList[t])}return e}}getParametersArray(e){let t=[],s=0,n=e.signature.length;for(let i=0;i<n;i++){let n=e.signature[i],r=n.identifiers.length;for(let e=0;e<r;e++)t[s++]=n}return t}addError(e,t=null,s=null){let i=this.errorsDescription.getErrorTextByCode(e)+(null===t?"":". "+t),r=null===s?null:s.symbol.textPosition;throw new n(e,i,r)}addType(e){let s=e.identifier.symbol.stringValue.toLowerCase();if(this.types.hasOwnProperty(s))this.addError(t.identifierAlreadyUsed,`Type '${s}' already declared.`,e);else if(this.types[s]=e.type,e.type instanceof we){let s=this;e.type.items.forEach((function(n){let i=n.symbol.stringValue.toLowerCase();s.enumsItems.hasOwnProperty(i)&&s.addError(t.identifierAlreadyUsed,`Enumeration item '${i}' already declared.`,n),s.enumsItems[i]=new Ne(n,e.type)}))}}getType(e,s=null){let n=e.toLowerCase();return this.types.hasOwnProperty(n)?this.types[n]:this.parentScope?this.parentScope.getType(e,s):void this.addError(t.typeNotDeclared,`Type '${n}' not declared.`,s)}getParametersList(){return this.parametersList}setParametersList(e){this.parametersList=e}addConstant(e){let s=e.identifier.symbol.stringValue,n=e.type,i=e.value,r=s.toLowerCase();if(this.constants.hasOwnProperty(r))this.addError(t.identifierAlreadyUsed,`Constant '${r}' already declared.`,e);else{let e=null,t=this.resolveNamedType(n);null===t||t instanceof L?e=new Pe(i.symbol.value,n?t.typeId:i.typeId):t instanceof ge&&i instanceof fe?e=this.createArrayVariable(t,i):t instanceof F&&i instanceof be&&(e=this.createVariable(t,i)),this.constants[r]=e}}getVariableByReference(e){let s=e.symbol.value.toLowerCase();if(this.items.hasOwnProperty(s))return this.items[s];{let n=this.parentScope.getVariableByReference(e);if(n)return n;this.addError(t.variableNotDeclared,`Variable '${s}' not declared.`,e)}}addVariableByReference(e,t){let s=t.symbol.value.toLowerCase(),n=this.parentScope.getVariableByReference(e);this.items[s]=n}createDefaultVariable(e){if(e instanceof L){let t=null;switch(e.typeId){case 6:t=!1;break;case 2:t=String.fromCharCode(0);break;case 0:case 1:t=0;break;case 7:t=""}return new Pe(t,e.typeId)}if(e instanceof F)return new Me(e,this);if(e instanceof pe){let t=new We;return t.signature=e.signature,t.type=e,new Ae(e,t)}if(e instanceof xe)return new Be(null,e);if(e instanceof ee){let t=new De;return t.signature=e.signature,t.returnType=e.returnType,t.name=new W({value:"outputValue"}),t.type=e,new Ae(e,t)}if(e instanceof ge){let t=this.resolveNamedType(e),s=new Re(t,this),n=t.leftIndex,i=t.rightIndex,r=this.getIntegerValueOfIndexConstant(n),a=this.getIntegerValueOfIndexConstant(i),l=Math.min(r,a),o=Math.max(r,a),h=-l;return s.offset=h,s.arrayLength=o-l+1,s.leftIntegerIndex=0,s.rightIntegerIndex=o,s.rightIntegerIndex=o,s}}typeIncluded(e,t){return e instanceof qe?t instanceof P||t instanceof N||t instanceof B||t instanceof we:e instanceof je?t instanceof ge:e instanceof O&&t instanceof N||this.sameType(e,t)}checkType(e,t){return!(e instanceof $e&&!this.typeIncluded(e,t))&&(e instanceof Z?t instanceof Z:e instanceof O?t instanceof N||t instanceof O:e instanceof B?t instanceof B:e instanceof R?t instanceof R:!(e instanceof T&&!this.sameType(e,t)||e instanceof Fe&&!this.typeIncluded(e.type,t)))}}class Ue extends f{constructor(e,t,s=[]){super(e),this.identifier=t,this.parameters=s}}class Ge extends De{constructor(){super("ord"),this.type=new ee(null,[new me(null,!1,new O,[new W(new o(null,null,"inputChar"))])],new B)}async innerRun(e){let t=e.getVariable("inputChar").value.charCodeAt(0);e.addVariable("ord",new B,t,null,!0),e.callableName="ord"}}class _e extends De{constructor(){super("chr"),this.type=new ee(null,[new me(null,!1,new B,[new W(new o(null,null,"inputInteger"))])],new N)}async innerRun(e){let t=e.getVariable("inputInteger").value,s=String.fromCharCode(t);e.addVariable("chr",new N,s,null,!0),e.callableName="chr"}}class Ke extends De{constructor(){super("low"),this.type=new ee(null,[new me(null,!1,new je,[new W(new o(null,null,"array"))])],new qe)}async innerRun(e){let t=e.getVariable("array").type.leftIndex,s=null,n=t.typeId,i=t.symbol.value;switch(n){case 6:s=new P(null);break;case 2:s=new N(null);break;case 0:s=new B(null)}e.addVariable("low",s,i,null,!0),e.callableName="low"}}class Xe extends De{constructor(){super("low"),this.type=new ee(null,[new me(null,!1,new Fe(new je),[new W(new o(null,null,"array"))])],new qe)}async innerRun(e){let t=e.getVariable("array").valueType.leftIndex,s=null,n=t.typeId,i=t.symbol.value;switch(n){case 6:s=new P(null);break;case 2:s=new N(null);break;case 0:s=new B(null)}e.addVariable("low",s,i,null,!0),e.callableName="low"}}class He extends De{constructor(){super("high"),this.type=new ee(null,[new me(null,!1,new je,[new W(new o(null,null,"array"))])],new qe)}async innerRun(e){let t=e.getVariable("array").type.rightIndex,s=null,n=t.typeId,i=t.symbol.value;switch(n){case 6:s=new P(null);break;case 2:s=new N(null);break;case 0:s=new B(null)}let r="high";e.addVariable(r,s,i,null,!0),e.callableName=r}}class Je extends De{constructor(){super("high"),this.type=new ee(null,[new me(null,!1,new Fe(new je),[new W(new o(null,null,"array"))])],new qe)}async innerRun(e){let t=e.getVariable("array").valueType.rightIndex,s=null,n=t.typeId,i=t.symbol.value;switch(n){case 6:s=new P(null);break;case 2:s=new N(null);break;case 0:s=new B(null)}let r="high";e.addVariable(r,s,i,null,!0),e.callableName=r}}class Qe extends De{constructor(){super("random"),this.type=new ee(null,[new me(null,!1,new B,[new W(new o(null,null,"limit"))])],new B)}async innerRun(e){let t=e.getVariable("limit"),s=Math.sign(t.value),n=Math.abs(t.value),i=Math.floor(Math.random()*n),r="random";e.addVariable(r,this.type.returnType,null,null,!0),e.callableName=r,e.setValue(new W(new o(null,null,r)),this.type.returnType,0===i?0:s*i)}}class Ye extends De{constructor(){super("random"),this.type=new ee(null,[],new M)}async innerRun(e){let t=Math.random(),s="random";e.addVariable(s,this.type.returnType,null,null,!0),e.callableName=s,e.setValue(new W(new o(null,null,s)),this.type.returnType,t)}}class Ze extends De{constructor(){super("length"),this.type=new ee(null,[new me(null,!1,new O,[new W(new o(null,null,"inputString"))])],new B)}async innerRun(e){let t=e.getVariable("inputString").value,s="string"==typeof t?t.length:0,n=new B,i="length";e.addVariable(i,n,s,null,!0),e.callableName=i}}class et extends We{constructor(e,t){super(),this.outputStream=e,this.ouputNewLineSymbol=t,this.type=new pe(null,new te,null)}async innerRun(e){let t=e.getParametersList();this.outputStream.write((null===t?"":t.map((function(e){return e instanceof Ne?e.value.symbol.stringValue:e instanceof Pe?e.value:void 0})).join(""))+this.ouputNewLineSymbol)}}class tt extends We{constructor(e){super(),this.outputStream=e,this.type=new pe(null,new te,null)}async innerRun(e){let t=e.getParametersList();this.outputStream.write(null===t?"":t.map((function(e){return e instanceof Ne?e.value.symbol.stringValue:e instanceof Pe?e.value:void 0})).join(""))}}class st extends We{constructor(e,t,s){super(),this.input=e,this.outputStream=t,this.ouputNewLineSymbol=s,this.type=new pe(null,new te(!0),null),this.char=null}async innerRun(e,s){let n=e.getParametersList(),i=[],r=[];await Promise.all(n.map((async e=>{let t=await s.evaluateIdentifierBranch(e);r.push(t.typeId),i.push(t.type)})));let a=await this.getWords(r,this.ouputNewLineSymbol);await a.forEach((async function(a,l){let o=null;switch(r[l]){case 0:o=Number.parseInt(a),isNaN(o)&&e.addError(t.typesMismatch,`Integer value expected, but '${a}' found.`,n[l]);break;case 1:o=parseFloat(a),isNaN(o)&&e.addError(t.typesMismatch,`Float value expected, but '${a}' found.`,n[l]);break;case 2:case 7:o=a;break;default:let s=i[l];s||(s=new L(null,r[l])),e.addError(t.typesMismatch,`Cannot input value of this type: ${s}`,n[l])}let h=new Pe(o,r[l]);await s.setIdentifierBranchValue(n[l],h)}))}async getWords(e){let t=[];for(let s=0;s<e.length;s++){let n=await this.getWord(e[0]);t[s]=n}return t}async getWord(e){let t="";switch(e){case 2:null===this.char?t=await this.input.getChar():(t=this.char,this.char=null);break;case 0:case 1:for(;null===this.char||null!==/[\r\n\s\t]/.exec(this.char);)await this.nextChar();do{t+=this.char,await this.nextChar()}while(null===/[\r\n\s\t]/.exec(this.char));break;default:for(null!==this.char&&""!==this.char&&"\n"!==this.char||await this.nextChar();this.char!==this.ouputNewLineSymbol;)t+=this.char,await this.nextChar()}return t}async nextChar(){let e=await this.input.getChar();this.char=e}}class nt extends We{constructor(e,t,s){super(),this.input=e,this.outputStream=t,this.ouputNewLineSymbol=s,this.type=new pe(null,new te(!0),null),this.char=null}async innerRun(e,s){let n=e.getParametersList(),i=[],r=[];await Promise.all(n.map((async e=>{let t=await s.evaluateIdentifierBranch(e);r.push(t.typeId),i.push(t.type)})));let a=await this.getWords(r,this.ouputNewLineSymbol);await a.forEach((async function(a,l){let o=null;switch(r[l]){case 0:o=Number.parseInt(a),isNaN(o)&&e.addError(t.typesMismatch,`Integer value expected, but '${a}' found.`,n[l]);break;case 1:o=parseFloat(a),isNaN(o)&&e.addError(t.typesMismatch,`Float value expected, but '${a}' found.`,n[l]);break;case 2:case 7:o=a;break;default:let s=i[l];s||(s=new L(null,r[l])),e.addError(t.typesMismatch,`Cannot input value of this type: ${s}`,n[l])}let h=new Pe(o,r[l]);await s.setIdentifierBranchValue(n[l],h)}))}async getWords(e){let t=[];for(let s=0;s<e.length;s++){let n=await this.getWord(e[0]);t[s]=n}return t}async getWord(e){let t="";switch(e){case 2:null===this.char?t=await this.input.getChar():(t=this.char,this.char=null);break;case 0:case 1:for(;null===this.char||null!==/[\r\n\s\t]/.exec(this.char);)await this.nextChar();do{t+=this.char,await this.nextChar()}while(null===/[\r\n\s\t]/.exec(this.char));break;default:for(null!==this.char&&""!==this.char&&"\n"!==this.char||await this.nextChar();this.char!==this.ouputNewLineSymbol;)t+=this.char,await this.nextChar()}return t}async nextChar(){let e=await this.input.getChar();this.char=e}}class it extends We{constructor(){super(),this.type=new pe(null,[],null)}async innerRun(e){}}class rt extends We{constructor(){super("val"),this.char=null,this.letters=[],this.charCounter=0,this.code=null}async baseRun(e){let t=e.getVariable("s"),s=e.getVariable("v"),n=0,i=1,r=1,a=!1;this.letters=t.value.split(""),this.charCounter=0;let l="",o=s.type.typeId;if(this.char=this.nextCh(),this.skipWhiteSpaces(),null!==/[+-]/.exec(this.char)&&(r="-"===this.char?-1:1,this.char=this.nextCh(),this.skipWhiteSpaces()),null!==this.char)switch(o){case 0:for(;/\d/.exec(this.char);)l+=this.char,this.char=this.nextCh();if(""===l){a=!0,i=this.charCounter;break}this.skipWhiteSpaces(),a||this.charCounter!==this.letters.length?this.charCounter!==this.letters.length&&(i=this.charCounter):(n=Number.parseInt(l)*r,i=0);break;case 1:let e=!1;for(;null!==/[\d\.]/.exec(this.char);){if("."===this.char){if(e){a=!0,i=this.charCounter;break}e=!0}l+=this.char,this.char=this.nextCh()}if("."===l)l+="0";else if(""===l){a=!0;break}if(/e/i.exec(this.char)){if(l+=this.char,this.char=this.nextCh(),!/[\d+-]/.exec(this.char)){i=this.charCounter,a=!0;break}if(/[+-]/.exec(this.char)&&(l+=this.char,this.char=this.nextCh()),!/\d/.exec(this.char)){i=this.charCounter,a=!0;break}for(;/\d/.exec(this.char);)l+=this.char,this.char=this.nextCh()}this.skipWhiteSpaces(),a||this.charCounter!==this.letters.length?this.charCounter!==this.letters.length&&(i=this.charCounter):(n=parseFloat(l)*r,i=0)}s.value=n,this.code=i}nextCh(){return this.charCounter<this.letters.length?this.letters[this.charCounter++]:null}skipWhiteSpaces(){for(;null!==this.char&&null!==/\s/.exec(this.char);)this.char=this.nextCh()}}class at extends rt{constructor(){super("val"),this.type=new pe(null,[new me(null,!1,new O,[new W(new o(null,null,"s"))]),new me(null,!0,new R,[new W(new o(null,null,"v"))])]),this.char=null,this.letters=[],this.charCounter=0}async innerRun(e){await this.baseRun(e)}}class lt extends rt{constructor(){super(),this.type=new pe(null,[new me(null,!1,new O,[new W(new o(null,null,"s"))]),new me(null,!0,new R,[new W(new o(null,null,"v"))]),new me(null,!0,new B,[new W(new o(null,null,"code"))])])}async innerRun(e){let t=e.getVariable("code");await this.baseRun(e),t.value=this.code}}class ot extends We{constructor(){super("str"),this.type=new pe(null,[new me(null,!1,new B,[new W(new o(null,null,"inputInteger"))]),new me(null,!0,new O,[new W(new o(null,null,"outputString"))])])}async innerRun(e){let t=e.getVariable("inputInteger"),s=e.getVariable("outputString"),n=`${t.value}`;s.value=n}}class ht extends We{constructor(){super("str"),this.type=new pe(null,[new me(null,!1,new M,[new W(new o(null,null,"inputReal"))]),new me(null,!0,new O,[new W(new o(null,null,"outputString"))])])}async innerRun(e){let t=e.getVariable("inputReal"),s=e.getVariable("outputString"),n=`${t.value}`;s.value=n}}class ct extends We{constructor(){super("delete"),this.type=new pe(null,[new me(null,!0,new O,[new W(new o(null,null,"S"))]),new me(null,!1,new B,[new W(new o(null,null,"Index"))]),new me(null,!1,new B,[new W(new o(null,null,"Count"))])])}async innerRun(e){let t=e.getVariable("S"),s=e.getVariable("Index").value,n=e.getVariable("Count").value;if(s>0&&n>0){let e=t.value,i=e.slice(0,s-1)+e.slice(s-1+n);t.value=i}}}class ut extends We{constructor(){super("inc"),this.type=new pe(null,[new me(null,!0,new B,[new W(new o(null,null,"inputInteger"))])])}async innerRun(e){let t=e.getVariable("inputInteger"),s=t.value;s++,t.value=s}}class yt extends We{constructor(){super("inc"),this.type=new pe(null,[new me(null,!0,new B,[new W(new o(null,null,"inputInteger"))]),new me(null,!1,new B,[new W(new o(null,null,"offsetInteger"))])])}async innerRun(e){let t=e.getVariable("inputInteger"),s=e.getVariable("offsetInteger"),n=t.value;n+=s.value,t.value=n}}class dt extends se{constructor(e,t,s){super(),this.items.chr=[new _e],this.items.ord=[new Ge],this.items.random=[new Qe,new Ye],this.items.low=[new Ke,new Xe],this.items.high=[new He,new Je],this.items.length=[new Ze],this.items.writeln=new et(t,s),this.items.write=new tt(t),this.items.readln=new st(e,t,s),this.items.read=new nt(e,t,s),this.items.randomize=new it,this.items.val=[new at,new lt],this.items.str=[new ot,new ht],this.items.delete=[new ct],this.items.inc=[new yt,new ut]}addFunction(e,t){this.items[e.toLowerCase()]=t}}class pt{constructor(e,t){this.tree=e,this.trees=[this.tree],this.treesCounter=0,this.scopes=[],this.currentScopeId=0,this.scopes[this.currentScopeId]=new ze,this.functionsStore=new dt(t.input,t.outputStream,t.ouputNewLineSymbol),this.errorsDescription=new s}getCurrentScope(){return this.scopes[this.currentScopeId]}async run(){if(this.setConstants(),this.setTypes(),this.setVariables(),this.tree.sentences)for(let e=0;e<this.tree.sentences.length;e++){if(this.tree.exit){this.tree.exit=!1;break}await this.evaluateSentence(this.tree.sentences[e])}}setVariables(){let e=this.getCurrentScope();this.tree.vars&&this.tree.vars.forEach((function(t){if(!(t instanceof j))throw"VariablesDeclaration object must be here!";t.variablesType,t.identifiers.forEach((function(s){if(!(s instanceof W))throw"Identifier must be here!";{e.addVariable(s,t.variablesType,null,s);let n=t.initialValue;n instanceof A?e.setValue(s,n.type,n.symbol.value,n):(n instanceof fe||n instanceof be)&&e.setValue(s,n.type,n,n)}}))}))}setTypes(){let e=this.getCurrentScope();this.tree.types&&this.tree.types.forEach((function(t){if(!(t instanceof U))throw"TypeDeclaration object must be here!";e.addType(t)}))}setConstants(){let e=this.getCurrentScope();this.tree.constants&&this.tree.constants.forEach((function(t){if(!(t instanceof z))throw"ConstantDeclaration object must be here!";e.addConstant(t)}))}async evaluateIndexRing(e){return e.evaluatedIndexExpression=await this.evaluateExpression(e.indexExpression),e.indexRing instanceof g&&await this.evaluateIndexRing(e.indexRing),e}async evaluateIdentifierBranchRunner(e,t=null,s=null){let n=await this.evaluateIdentifierBranch(e,t,s);for(;n instanceof Ae;){let e=this.getCurrentScope(),t=n.value,i=t.type,r=i.returnType;if(!(Array.isArray(i.signature)&&0===i.signature.length&&null===s||i.signature instanceof te||!e.checkType(s,i)&&(i instanceof pe||e.checkType(s,r))))break;{let s=new ze(e),i=null;if(t instanceof ae){let e=t.name;i=e.symbol.value.toLowerCase(),s.addVariable(e,t.type.returnType,null,null,!0),s.callableName=t.name.symbol.value}else t instanceof De&&(i=t.name);this.treesCounter++,this.tree=t,this.trees[this.treesCounter]=this.tree,this.currentScopeId++,this.scopes[this.currentScopeId]=s,await this.run(),"function"==typeof t.innerRun&&await t.innerRun(s,this);let r=null;(t instanceof De||t instanceof ae)&&(r=s.getVariable(i)),delete this.scopes[this.currentScopeId],this.currentScopeId--,this.treesCounter--,this.tree=this.trees[this.treesCounter],n=r}}return n}async evaluateIdentifierBranch(e,s=null,n=null){if(e instanceof W){let i=this.getCurrentScope(),r=e.symbol.value,a=i.getElementByIdentifier(e);if(null!==a&&(null===n||i.checkType(n,a.type)))return a;let l=r.toLowerCase(),o=this.tree.functionsStore.getFunction(l,i,s,n)||this.functionsStore.getFunction(l,i,s,n);if(null!==o)return new Ae(Array.isArray(o)?new ee(null):o.type,o);this.addError(t.variableNotDeclared,`Element '${r}' not declared.`,e)}else if(e instanceof w){let n=this.getCurrentScope(),i=await this.evaluateIdentifierBranch(e.identifier,s),r=i.type;await this.evaluateIndexRing(e.indexRing);let a=e.indexRing;if(r instanceof ge)return i.getByIndexRing(a);if(r instanceof O){null!==a.indexRing&&this.addError(t.typesMismatch," Illegal qualifier. Cannot apply more than one indices to String.",e);let s=a.evaluatedIndexExpression.type;s instanceof B||0===s.typeId||this.addError(t.typesMismatch,`Integer index expected but ${s} found.`,a.indexExpression);let r=a.evaluatedIndexExpression.value,l=i.value,o="string"==typeof l?l.length:0,h=0!==r&&r>=1&&r<=o?l[r-1]:String.fromCharCode(0);return n.createVariable(new N,h)}this.addError(t.typesMismatch,`Array or String expected but ${i.type} found.`,e)}else{if(e instanceof D){let t=e.parameters,s=await Promise.all(t.map((async e=>await this.evaluateExpression(e)))),n=[];Array.isArray(s)&&(n=s.map((e=>e.type)));let i=await this.evaluateIdentifierBranch(e.identifierBranch,n,new Z),r=i instanceof Ae?i.value:i,a=this.getCurrentScope(),l=new ze(a),o=null;if(r instanceof ae){let e=r.name;o=e.symbol.value.toLowerCase(),l.addVariable(e,r.type.returnType,null,null,!0),l.callableName=r.name.symbol.value}else r instanceof De&&(o=r.name);await this.addParametersToScope(e.parameters,s,r.type.signature,l),this.treesCounter++,this.tree=r,this.trees[this.treesCounter]=this.tree,this.currentScopeId++,this.scopes[this.currentScopeId]=l,await this.run(),"function"==typeof r.innerRun&&await r.innerRun(l,this);let h=null;return(r instanceof De||r instanceof ae)&&(h=l.getVariable(o)),delete this.scopes[this.currentScopeId],this.currentScopeId--,this.treesCounter--,this.tree=this.trees[this.treesCounter],h}if(e instanceof x)return(await this.evaluateIdentifierBranch(e.pointer,s)).variable;if(e instanceof C){let t=await this.evaluateIdentifierBranch(e.baseExpression,s),n=e.subField;return t.getByPropertyIdentifier(n)}this.addError(t.typesMismatch,"Identifier branch expected.",e)}}async evaluateSentence(e){let s=this.getCurrentScope();if(e instanceof b){let n=e.destination,i=await this.evaluateIdentifierBranch(n),a=i.type,l=e.sourceExpression,o=await this.evaluateExpression(l,a),h=o.getType(),c=e.symbol.symbolCode;switch(c){case r.plusAssign:case r.minusAssign:case r.slashAssign:case r.starAssign:let s=i.getType(),n=s.typeId,a=h.typeId;switch(a){case 1:case 0:case 7:case 2:break;default:this.addError(t.typesMismatch,"Non-numeric value to assign",e)}switch(s.typeId){case 1:break;case 0:1!==a.typeId&&c!==r.slashAssign||this.addError(t.typesMismatch,"Cannot assign floating point value to an integer variable",e);break;case 7:2!==a&&7!==a&&this.addError(t.typesMismatch,"Cannot assign non-character value to a string",e);break;default:this.addError(t.typesMismatch,"Non-numeric destination for assign operator",e)}let l=null;switch(c){case r.plusAssign:l=i.value+o.value;break;case r.minusAssign:l=i.value-o.value;break;case r.slashAssign:l=i.value/o.value;break;case r.starAssign:l=i.value*o.value}o=new Pe(l,n);default:case r.assign:}if(n instanceof C){let e=await this.evaluateIdentifierBranch(n.baseExpression),t=n.subField;s.setRecordVariableProperty(e,t,o)}else{let i=null,r=null;if(n instanceof w&&(await this.evaluateIndexRing(n.indexRing),i=await this.evaluateIdentifierBranch(n.identifier),r=i.type),n instanceof w&&r instanceof O){let e=n.indexRing;null!==e.indexRing&&this.addError(t.typesMismatch," Illegal qualifier. Cannot apply more than one indices to String.",identifierBranchExpression);let s=e.evaluatedIndexExpression.type;s instanceof B||0===s.typeId||this.addError(t.typesMismatch,`Integer index expected but ${s} found.`,e.indexExpression);let r=o.type,a=o.value;(r instanceof O||r instanceof N)&&"string"==typeof a&&1===a.length||this.addError(t.typesMismatch,`A Char expected but '${a}' found.`,l);let h=e.evaluatedIndexExpression.value,c=i.value,u="string"==typeof c?c.length:0;h>0&&h<=u&&(i.value=c.substring(0,h-1)+a+c.substring(h))}else s.setVariableValue(n,o,e.destination)}}else if(e instanceof G){if(e.sentences){let t=e.sentences,s=t.length;for(let e=0;e<s;e++){let s=await this.evaluateSentence(t[e]);if(s instanceof Ve||s instanceof ke)return s}}}else{if(e instanceof _)return!0===(await this.evaluateExpression(e.condition)).value?await this.evaluateSentence(e.left):await this.evaluateSentence(e.right);if(e instanceof D||e instanceof Ue)return await this.evaluateIdentifierBranch(e);if(e instanceof Se){let t=this.getCurrentScope();for(t.cycleDepth++;!0===(await this.evaluateExpression(e.condition)).value;){let t=await this.evaluateSentence(e.body);if(t instanceof Ve||t instanceof ke)break}t.cycleDepth--}else if(e instanceof Ce){let t=this.getCurrentScope();t.cycleDepth++;do{let t=await this.evaluateSentence(e.body);if(t instanceof Ve||t instanceof ke)break}while(!0!==(await this.evaluateExpression(e.condition)).value);t.cycleDepth--}else if(e instanceof Ee){let t=this.getCurrentScope(),s=e.variableIdentifier,n=await this.evaluateExpression(e.initExpression),i=t.createVariable(n.type,n.value),r=await this.evaluateExpression(e.lastExpression),a=null,l=null,o=i.typeId,h=i.type;if(t.setValue(s,h,i.value,s),e.countDown)switch(o){case 0:a=function(e){return e.value--,e},l=(e,t)=>e.value>=t.value;break;case 2:a=function(e){let t=e.value.charCodeAt(0);return t--,e.value=String.fromCharCode(t),e},l=(e,t)=>e.value.charCodeAt(0)>=t.value.charCodeAt(0);break;case 5:a=function(e){let t=e.type.items,s=t.length,n=e.getIndex();return n--,e.value=t[(n+s)%s],e},l=(e,t)=>e.getIndex()>=t.getIndex()}else switch(o){case 0:a=function(e){return e.value++,e},l=(e,t)=>e.value<=t.value;break;case 2:a=function(e){let t=e.value.charCodeAt(0);return t++,e.value=String.fromCharCode(t),e},l=(e,t)=>e.value.charCodeAt(0)<=t.value.charCodeAt(0);break;case 5:a=function(e){let t=e.type.items,s=t.length,n=e.getIndex();return n++,e.value=t[n%s],e},l=(e,t)=>e.getIndex()<=t.getIndex()}t.cycleDepth++;let c=5===o?new Ne(i.value,h):new Pe(i.value,h),u=!0;for(;l(i,r)&&u;){let n=await this.evaluateSentence(e.body);if(n instanceof Ve||n instanceof ke)break;c.value=i.value,i=a(i),t.setValue(s,h,i.value),u=l(c,i)}t.cycleDepth--}else if(e instanceof Ve){if(!(this.getCurrentScope().cycleDepth<=0))return e;this.addError(t.breakOutOfLoop,null,e)}else if(e instanceof ve){let s=await this.evaluateExpression(e.switchExpression),n=!1;this.getCurrentScope();for(let i=0;i<e.cases.length;i++){let r=e.cases[i];for(let e=0;e<r.constants.length;e++){let i=r.constants[e];if(i.typeId!==s.type.typeId&&this.addError(t.typesMismatch,"The constant and the switch expression have different types",i),i.symbol.value===s.value){n=!0,this.evaluateSentence(r.operator);break}}if(n)break}n||null===e.elseSentence||this.evaluateSentence(e.elseSentence)}else if(e instanceof W)await this.evaluateIdentifierBranchRunner(e);else if(e instanceof ke){this.tree.exit=!0;let s=e.exitExpression;if(null!==s)if(this.tree instanceof ae){let e=await this.evaluateExpression(s),t=this.tree.name;this.getCurrentScope().setVariableValue(t,e,s)}else this.tree instanceof re&&this.addError(t.typesMismatch,"Procedure cannot return a value",s);return e}}}async addParametersToScope(e,s,n,i){if(n instanceof te)n.byReference?i.setParametersList(e):i.setParametersList(s);else{let r=0;for(let a=0;a<n.length;a++){let l=n[a],o=l.identifiers,h=l.byReference;for(let n=0;n<o.length;n++){let a=o[n],c=l.type,u=e[r];if(h)u instanceof W||this.addError(t.identifierExpected,"Cannot use other expressions here",u),i.addVariableByReference(u,a);else{let e=s[r];c instanceof $e&&(c=e.type),i.addVariable(a,c),i.setValue(a,c,e,a)}r++}}}}async evaluateExpression(e,t=null){if(e instanceof S){let t=e.identifier,s=await this.evaluateIdentifierBranch(t),n=s.getType();return new Be(s,n)}if(e instanceof oe){let t=await this.evaluateExpression(e.left),s=await this.evaluateExpression(e.right),n=6,i=null;return i=5===t.typeId&&5===s.typeId&&Object.is(t.type,s.type)?t.getIndex()===s.getIndex():t.value===s.value,new Pe(i,n)}if(e instanceof ue){let t=await this.evaluateExpression(e.left),s=await this.evaluateExpression(e.right),n=6,i=null;return i=2===t.typeId&&2===s.typeId?t.value.charCodeAt(0)>s.value.charCodeAt(0):5===t.typeId&&5===s.typeId&&Object.is(t.type,s.type)?t.getIndex()>s.getIndex():t.value>s.value,new Pe(i,n)}if(e instanceof ce){let t=await this.evaluateExpression(e.left),s=await this.evaluateExpression(e.right),n=6,i=null;return i=2===t.typeId&&2===s.typeId?t.value.charCodeAt(0)<s.value.charCodeAt(0):5===t.typeId&&5===s.typeId&&Object.is(t.type,s.type)?t.getIndex()<s.getIndex():t.value<s.value,new Pe(i,n)}if(e instanceof ye){let t=await this.evaluateExpression(e.left),s=await this.evaluateExpression(e.right),n=6,i=null;return i=2===t.typeId&&2===s.typeId?t.value.charCodeAt(0)>=s.value.charCodeAt(0):5===t.typeId&&5===s.typeId&&Object.is(t.type,s.type)?t.getIndex()>=s.getIndex():t.value>=s.value,new Pe(i,n)}if(e instanceof de){let t=await this.evaluateExpression(e.left),s=await this.evaluateExpression(e.right),n=6,i=null;return i=2===t.typeId&&2===s.typeId?t.value.charCodeAt(0)<=s.value.charCodeAt(0):5===t.typeId&&5===s.typeId&&Object.is(t.type,s.type)?t.getIndex()<=s.getIndex():t.value<=s.value,new Pe(i,n)}if(e instanceof he){let t=await this.evaluateExpression(e.left),s=await this.evaluateExpression(e.right),n=6,i=null;return i=5===t.typeId&&5===s.typeId&&Object.is(t.type,s.type)?t.getIndex()!==s.getIndex():t.value!==s.value,new Pe(i,n)}return e instanceof le?(await this.evaluateExpression(e.left),await this.evaluateExpression(e.right),new Pe(!1,6)):await this.evaluateSimpleExpression(e,t)}async evaluateSimpleExpression(e,t=null){if(e instanceof V||e instanceof k){let t=await this.evaluateSimpleExpression(e.left),s=await this.evaluateSimpleExpression(e.right),n=t.type instanceof O&&s.type instanceof O?7:1===t.typeId||1===s.typeId?1:0,i=null;return e instanceof V?i=t.value+s.value:e instanceof k&&(i=t.value-s.value),new Pe(i,n)}if(e instanceof J){let t=await this.evaluateSimpleExpression(e.left),s=await this.evaluateSimpleExpression(e.right),n=6,i=t.value||s.value;return new Pe(i,n)}return await this.evaluateTerm(e,t)}async evaluateTerm(e,t=null){if(e instanceof Y){let t=await this.evaluateTerm(e.value);return new Pe(!t.value,t.typeId)}if(e instanceof Q){let t=await this.evaluateTerm(e.value);return new Pe(-t.value,t.typeId)}if(e instanceof I){let t=await this.evaluateMultiplier(e.left),s=await this.evaluateMultiplier(e.right),n=1===t.typeId||1===s.typeId?1:0,i=t.value*s.value;return new Pe(i,n)}if(e instanceof E){let t=await this.evaluateMultiplier(e.left),s=await this.evaluateMultiplier(e.right),n=1,i=t.value/s.value;return new Pe(i,n)}if(e instanceof K){let t=await this.evaluateMultiplier(e.left),s=await this.evaluateMultiplier(e.right),n=0,i=Math.trunc(t.value/s.value);return new Pe(i,n)}if(e instanceof X){let t=await this.evaluateMultiplier(e.left),s=await this.evaluateMultiplier(e.right),n=0,i=t.value%s.value;return new Pe(i,n)}if(e instanceof H){let t=await this.evaluateMultiplier(e.left),s=await this.evaluateMultiplier(e.right),n=6,i=t.value&&s.value;return new Pe(i,n)}return await this.evaluateMultiplier(e,t)}async evaluateMultiplier(e,t=null){return e instanceof A?new Pe(e.symbol.value,e.typeId):e instanceof D||e instanceof W||e instanceof w||e instanceof x||e instanceof C?await this.evaluateIdentifierBranchRunner(e,null,t):await this.evaluateExpression(e)}addError(e,t=null,s=null){let i=this.errorsDescription.getErrorTextByCode(e)+(null===t?"":". "+t),r=null===s?null:s.symbol.textPosition;throw new n(e,i,r)}async setIdentifierBranchValue(e,t){let s=this.getCurrentScope();if(e instanceof C){let n=await this.evaluateIdentifierBranch(e.baseExpression),i=e.subField;s.setRecordVariableProperty(n,i,t)}else e instanceof w&&this.evaluateIndexRing(e.indexRing),s.setVariableValue(e,t,e)}}class mt{engine;error;constructor(e){this.config=e}async runString(e){let t=e=>{if(!(e instanceof n))throw e;{s.printListing(e);let t=this.config.listingOutput.outputLines;for(let e=0;e<t.length;e++)this.config.outputStream.addLine(t[e],!0);this.error=e}};try{var s=new i(e,this.config.listingOutput),r=new p(s),a=new Te(r).analyze(),l=new pt(a,this.config);await l.run().catch(t)}catch(e){t(e)}return this.engine=l,l}getVar(e){return this.engine.getCurrentScope().items[e]}getVarValue(e){let t=this.getVar(e);return 3===t.typeId?this.getVar(e).items:5===t.typeId?this.getVar(e).value.symbol.stringValue:this.getVar(e).value}getError(){return this.error}}function ft(e){return(e<10?1:Math.floor(Math.log10(e)))+1}class bt extends class{constructor(){this.errorsCounter=0}listErrors(e){e.forEach((e=>this.listError(e)))}getLinePrefix(e){return"  "+(e<10?"0":"")+e+"    "}getErrorText(e,t){var s=ft(e.textPosition.lineNumber),n=s-ft(t),i=n<0?2+n:2,r=s+4;return"**"+(t<10?"0":"")+"0".repeat(n>0?n:0)+t+"*".repeat(i)+" ".repeat(e.textPosition.charNumber+1)+"^ Error Code "+e.errorCode+"\n"+"*".repeat(r)+"  "+e.errorText}listError(e){console.log(this.getErrorText(e,++this.errorsCounter))}}{constructor(){super(),this.outputLines=[]}listLine(e,t){var s=this.getLinePrefix(t+1)+e;this.outputLines.push(s.replace(/[\n\r]/g,""))}listError(e){this.outputLines.push(this.getErrorText(e,++this.errorsCounter))}clearLines(){this.outputLines=[]}}class wt{constructor(){this.screen=document.querySelector(".screen"),this.letters=[],this.lettersCounter=0}getLine(e=!1){let t=document.querySelector(".screen"),s=t.querySelectorAll("div"),n=null;return e||0===s.length?(n=document.createElement("div"),t.appendChild(n)):n=s[s.length-1],n}addLine(e,t=!1){let s=this.getLine(t),n=document.createElement("span");n.textContent=e.replace(/ /g,""),s.appendChild(n),n.scrollIntoView()}write(e){let t=e.split("\n");this.addLine(t[0]);for(let e=1;e<t.length;e++)this.addLine(t[e],!0)}async read(e=!1){let t=this.getLine(e),s=document.createElement("span");s.contentEditable="true",t.appendChild(s),s.scrollIntoView();let n=document.querySelector(".screen");n.click();let i=this,r=function(e){if("Enter"===e.key){let t=this.querySelector("span[contenteditable=true");t&&(t.contentEditable="false",i.addLine("",!0),e.preventDefault(),n.removeEventListener("click",r))}},a=new Promise((function(e,t){setInterval((()=>{"false"===s.contentEditable&&e(s.textContent.replace(/\s/g," "))}),300)}));return n.addEventListener("keydown",r),a}async getChar(){if(0===this.letters.length||this.lettersCounter>=this.letters.length){let e=await this.read()+"\n";this.letters=e.split(""),this.lettersCounter=0}let e=this.letters[this.lettersCounter];return this.lettersCounter++,e}}function gt(e){let t=document.querySelector("div.screen div span[contenteditable=true]");if(e.preventDefault(),t){let e=document.createRange(),s=window.getSelection();0===t.childNodes.length&&t.appendChild(document.createTextNode(""));let n=t.childNodes[0].length;s.anchorOffset!==n&&0!==n||(e.setStart(t.childNodes[0],n),e.collapse(!0),s.removeAllRanges(),s.addRange(e))}}document.addEventListener("DOMContentLoaded",(()=>{let e=document.createElement("dialog"),t=document.createElement("div");t.classList.add("screen");let s=document.createElement("button");s.id="close",s.textContent="",e.appendChild(t),e.appendChild(s),document.querySelector("body").appendChild(e),t.addEventListener("click",gt);let n=new wt;const i={outputStream:n,listingOutput:new bt,ouputNewLineSymbol:"\n",input:n};let r=document.querySelectorAll("div.delphi");document.querySelector("#close").onclick=function(){e.close(),i.listingOutput.clearLines(),t.replaceChildren()},r.forEach((t=>{t.querySelector("div.toolbar span a.command_help");let s=document.createElement("div");s.classList.add("run_button"),s.textContent="";let n=t.parentNode;n.prepend(s),s.addEventListener("click",(async function(t){e.showModal();let s=n.querySelector("table tbody tr td.code div.container").querySelectorAll("div.line"),r=[];for(let e=0;e<s.length;e++){let t=[...s[e].childNodes];for(let e=0;e<t.length;e++){let s=t[e];r.push(s.tagName&&"BR"===s.tagName?"\n":t[e].textContent.replace(/\s/g," "))}r.push("\n")}let a=r.join(""),l=new mt(i);try{await l.runString(a)}catch(e){}i.outputStream.value="",t.preventDefault()}))}))}))})();